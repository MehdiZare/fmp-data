name: Publish-to-TestPyPI

# Pre-release publishing workflow for test releases
# Triggered manually or by pre-release tags

on:
  push:
    tags:
      - 'v*.*.*rc*'            # Release candidates (v1.2.3rc1)
      - 'v*.*.*a*'             # Alpha releases (v1.2.3a1)
      - 'v*.*.*b*'             # Beta releases (v1.2.3b1)
      - 'v*.*.*dev*'           # Dev releases (v1.2.3dev1)

permissions:
  id-token: write              # OIDC → Trusted Publishing

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.12"

    steps:
      - name: 🛎️  Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for hatch-vcs versioning

      - name: 🐍  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ⚡  Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: 📦  Build wheel & sdist
        run: |
          uv pip install build hatch
          uv run python -m build --wheel --sdist

      - name: 🚀  Upload to Test PyPI
        uses: pypa/gh-action-pypi-publish@v1.12.4
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist
          skip-existing: true
