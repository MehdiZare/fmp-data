name: Debug PR-label pick-up

on:
  workflow_dispatch:          # manual run
  pull_request:               # run automatically for every PR

permissions:
  contents: read
  pull-requests: read

jobs:
  show-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print label derived bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          # 1. when the workflow is triggered by a PR event, its
          #    number is available directly as ${{ github.event.number }}
          pr="${{ github.event.pull_request.number || '' }}"

          # 2. if not running on a PR event (e.g. manual), look-up by commit
          if [[ -z "$pr" ]]; then
            pr_json="$(gh api "repos/${{ github.repository }}/commits/${GITHUB_SHA}/pulls" \
                      -H 'Accept: application/vnd.github.groot-preview+json' || true)"
            pr="$(jq -r '.[0].number // empty' <<<"$pr_json")"
          fi

          if [[ -z "$pr" ]]; then
            echo "::error::No pull-request found for commit ${GITHUB_SHA}"
            exit 1
          fi
          echo "🔍  PR #: $pr"

          labels="$(gh pr view "$pr" --json labels --jq '.labels[].name')"
          echo "Labels on PR: $labels"

          bump=""
          [[ "$labels" == *"release:patch"* ]] && bump=patch
          [[ "$labels" == *"release:minor"* ]] && bump=minor
          [[ "$labels" == *"release:major"* ]] && bump=major
          echo "Derived bump →  $bump"

          label_cnt="$(grep -c 'release:' <<<"$labels" || true)"
          if [[ -z "$bump" || $label_cnt -ne 1 ]]; then
            echo "::warning::Exactly one release:* label required – current count: $label_cnt"
          else
            echo "✅  guard-label logic would succeed"
          fi
