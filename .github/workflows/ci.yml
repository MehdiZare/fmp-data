name: Test-Matrix

on:
  pull_request:

permissions:
  contents: read

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
      - name: 🛎️  Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: ⚡  Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: 🗄️  Cache uv wheels
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-py${{ matrix.python }}-uv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python }}-uv-

      - name: ▶️  Run Tests
        env:
          NOX_USE_UV: "1"
          CI: "true"
        run: |
          # Clean any existing coverage files
          rm -f .coverage*

          # Install nox first
          uv tool install nox

          # Ensure we're in the repo root
          cd $GITHUB_WORKSPACE

          # Run tests for each feature group with correct nox syntax
          echo "Running tests for Python ${{ matrix.python }}"

          # Use the correct parametrized session syntax with parentheses
          uv tool run nox -s "tests-${{ matrix.python }}(core)"
          uv tool run nox -s "tests-${{ matrix.python }}(langchain)"
          uv tool run nox -s "tests-${{ matrix.python }}(mcp-server)"

          # Verify coverage files were created
          echo "Coverage files generated:"
          ls -la .coverage* || echo "No coverage files found"

      - name: 🔍 Debug coverage files before upload
        run: |
          echo "Current working directory:"
          pwd
          echo "Environment GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          cd $GITHUB_WORKSPACE
          echo "Now in: $(pwd)"
          echo "All files in current directory:"
          ls -la
          echo "Looking for coverage files:"
          find . -name ".coverage*" -type f 2>/dev/null || echo "No .coverage files found with find"
          ls .coverage* 2>/dev/null || echo "No .coverage files found with ls"

      - name: 📤 Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python }}
          path: .coverage*
          retention-days: 1
          if-no-files-found: warn

      - name: 🔍 Quality Gates
        if: matrix.python == '3.13'
        env:
          NOX_USE_UV: "1"
        run: |
          uv tool run nox -s lint typecheck security

  coverage:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: 🛎️  Checkout
        uses: actions/checkout@v4

      - name: 🐍  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ⚡  Install uv
        uses: astral-sh/setup-uv@v6

      - name: 📦 Install dependencies
        env:
          NOX_USE_UV: "1"
        run: |
          uv tool install nox

      - name: 📥 Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: ./artifacts

      - name: 🔍 Debug downloaded artifacts
        run: |
          echo "All files in current directory:"
          ls -la
          echo "Files in artifacts directory:"
          ls -la ./artifacts/ || echo "No artifacts directory"
          echo "Looking for coverage files in artifacts:"
          find ./artifacts -name ".coverage*" -type f 2>/dev/null || echo "No coverage files found in artifacts"

          # Move coverage files to root directory
          echo "Moving coverage files to root:"
          find ./artifacts -name ".coverage*" -type f -exec mv {} . \; 2>/dev/null || echo "No coverage files to move"

          echo "Coverage files now in root:"
          ls -la .coverage* 2>/dev/null || echo "No coverage files in root"

      - name: 📊 Combine coverage and generate report
        env:
          NOX_USE_UV: "1"
        run: |
          # Verify we have coverage files
          if ! ls .coverage.* 1> /dev/null 2>&1; then
            echo "ERROR: No coverage files found after download!"
            echo "Let's check what we have:"
            ls -la
            find . -name "*coverage*" -type f 2>/dev/null || echo "No files with 'coverage' in name"
            exit 1
          fi

          echo "Found coverage files:"
          ls -la .coverage*

          uv tool run nox -s coverage_report

      - name: 📈 Coverage upload
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          flags: unittests
          fail_ci_if_error: false
