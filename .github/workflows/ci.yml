name: Test-Matrix

on:
  pull_request:                # run on every PR (open & update)

permissions:
  contents: read

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
      # â‘  Checkout
      - name: ğŸ›ï¸  Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â‘¡ CPython toolchain
      - name: ğŸ  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      # â‘¢ uv installer + cache
      - name: âš¡  Install uv (with cache)
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: ğŸ—„ï¸  Cache uv wheels
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-py${{ matrix.python }}-uv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python }}-uv-

      # â‘£ Run Nox sessions with individual coverage
      - name: â–¶ï¸  Run Tests
        env:
          NOX_USE_UV: "1"
          CI: "true"  # Ensure CI environment is detected
        run: |
          # Run tests for this Python version only, but all feature groups
          uv tool run nox -s "tests-${{ matrix.python }}"

      # â‘¤ Upload coverage artifacts for combination later
      - name: ğŸ“¤ Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python }}
          path: .coverage.*
          retention-days: 1

      # â‘¥ Quality gates (lint, type-check, security) once on latest LTS
      - name: ğŸ” Quality Gates
        if: matrix.python == '3.13'
        env:
          NOX_USE_UV: "1"
        run: |
          uv tool run nox -s lint typecheck security

  # New job to combine coverage from all matrix jobs
  coverage:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸  Checkout
        uses: actions/checkout@v4

      - name: ğŸ  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: âš¡  Install uv
        uses: astral-sh/setup-uv@v6

      - name: ğŸ“¥ Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: ğŸ“Š Combine coverage and generate report
        env:
          NOX_USE_UV: "1"
        run: |
          # Install dependencies needed for coverage
          uv tool run nox -s coverage_report

      - name: ğŸ“ˆ Coverage upload
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          flags: unittests
          fail_ci_if_error: false
